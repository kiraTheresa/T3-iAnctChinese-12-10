# 古文智能标注与解析系统 - 项目详细设计文档

## 1. 系统架构设计

### 1.1 总体架构

本系统采用前后端分离的架构设计，主要分为前端应用、后端服务和AI服务三个核心模块。各模块之间通过RESTful API进行通信，实现了高度的模块化和松耦合。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              前端应用                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   项目管理模块   │  │   文档管理模块   │  │  文本编辑与标注模块     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   用户管理模块   │  │   AI智能分析模块 │  │  数据可视化模块         │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ RESTful API
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              后端服务                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   用户服务      │  │   项目服务      │  │   文档服务              │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   标注服务      │  │   可视化服务    │  │   导出服务              │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                              代理层                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ RESTful API
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              AI服务                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   文本分析服务   │  │   问答服务      │  │   自动标注服务          │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ RESTful API
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              外部服务                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   百度千帆ERNIE X1 │  │   分词服务      │  │   地图服务              │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈

| 模块 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 前端框架 | React | 18+ | 构建用户界面 |
| 前端构建工具 | Vite | 5+ | 开发和构建前端应用 |
| 前端样式 | Tailwind CSS | 3+ | 样式管理 |
| 后端框架 | Express | 4+ | 构建RESTful API |
| 后端语言 | Node.js | 16+ | 服务器端运行环境 |
| AI服务框架 | Flask | 3+ | 构建AI服务API |
| AI服务语言 | Python | 3.8+ | AI模型集成 |
| 数据库 | MySQL | 8.0+ | 数据存储 |
| 认证 | JWT | - | 用户身份验证 |
| AI模型 | DeepSeek API / Xunzi-Qwen2-1.5B | - | 文本分析和生成 |

### 1.3 部署架构

系统采用分布式部署架构，各服务模块可以独立部署和扩展，提高了系统的可靠性和可扩展性。

- **前端应用**：部署在Web服务器上，如Nginx或Apache
- **后端服务**：部署在Node.js服务器上，可使用PM2进行进程管理
- **AI服务**：部署在Python服务器上，可使用Gunicorn进行进程管理
- **数据库**：部署在独立的MySQL服务器上

## 2. 前端详细设计

### 2.1 前端目录结构

```
frontend/
├── public/                 # 静态资源
├── src/
│   ├── components/         # 组件
│   │   ├── common/         # 通用组件
│   │   ├── documents/      # 文档相关组件
│   │   ├── editor/         # 编辑器相关组件
│   │   ├── projects/       # 项目相关组件
│   │   └── visualization/  # 可视化相关组件
│   ├── hooks/              # 自定义Hooks
│   ├── pages/              # 页面组件
│   ├── services/           # API服务
│   ├── styles/             # 样式文件
│   ├── utils/              # 工具函数
│   ├── App.jsx             # 应用入口组件
│   └── main.jsx            # 应用入口文件
├── index.html              # HTML模板
├── package.json            # 依赖配置
└── vite.config.js          # Vite配置
```

### 2.2 核心组件设计

#### 2.2.1 用户管理组件

- **Login.jsx**：用户登录组件，处理用户登录逻辑
- **Register.jsx**：用户注册组件，处理用户注册逻辑
- **Profile.jsx**：用户个人信息组件，显示和编辑用户信息
- **Settings.jsx**：系统设置组件，管理系统偏好设置

#### 2.2.2 项目管理组件

- **ProjectList.jsx**：项目列表组件，展示用户创建的所有项目
- **ProjectCard.jsx**：项目卡片组件，展示单个项目信息
- **ProjectForm.jsx**：项目表单组件，用于创建和编辑项目

#### 2.2.3 文档管理组件

- **DocumentList.jsx**：文档列表组件，展示项目下的所有文档
- **DocumentCard.jsx**：文档卡片组件，展示单个文档信息
- **DocumentForm.jsx**：文档表单组件，用于创建和编辑文档

#### 2.2.4 文本编辑与标注组件

- **TextEditor.jsx**：文本编辑器组件，用于编辑古文文本
- **EntityAnnotator.jsx**：实体标注组件，用于手动标注实体
- **RelationAnnotator.jsx**：关系标注组件，用于标注实体之间的关系
- **Segmentation.jsx**：分词组件，展示文本的分词结果
- **ClassicalAnalysis.jsx**：古文分析组件，展示AI对文本的分析结果

#### 2.2.5 数据可视化组件

- **DataVisualization.jsx**：数据可视化总览组件
- **HeatmapVisualization.jsx**：热力图可视化组件
- **LocationMap.jsx**：地点地图可视化组件
- **RelationshipGraph.jsx**：人物关系图组件
- **TimelineVisualization.jsx**：时间轴可视化组件

### 2.3 前端服务设计

前端服务主要负责与后端API进行通信，提供了以下核心服务：

- **authService.js**：用户认证服务，处理登录、注册和Token管理
- **projectService.js**：项目服务，处理项目的CRUD操作
- **documentService.js**：文档服务，处理文档的CRUD操作
- **aiService.js**：AI服务，处理文本分析、问答和自动标注
- **segmentationService.js**：分词服务，处理文本分词

## 3. 后端详细设计

### 3.1 后端目录结构

```
backend/
└── server/
    ├── AI/                # AI服务模块
    ├── seg/               # 分词服务模块
    └── user/              # 用户服务模块
        ├── config/        # 配置文件
        ├── middleware/    # 中间件
        ├── migrations/    # 数据库迁移
        ├── models/        # 数据模型
        └── routes/        # 路由
```

### 3.2 后端服务设计

#### 3.2.1 用户服务

用户服务负责用户的注册、登录和个人信息管理，主要包括以下功能：

- **用户认证**：使用JWT进行身份验证
- **用户管理**：处理用户的CRUD操作
- **设置管理**：管理用户的系统偏好设置

#### 3.2.2 项目服务

项目服务负责项目的管理，主要包括以下功能：

- **项目CRUD**：处理项目的创建、读取、更新和删除操作
- **项目权限**：确保用户只能访问自己的项目

#### 3.2.3 文档服务

文档服务负责文档的管理，主要包括以下功能：

- **文档CRUD**：处理文档的创建、读取、更新和删除操作
- **文档搜索**：支持根据关键词搜索文档
- **文档导出**：支持将文档内容和标注数据导出为CSV和TXT格式

#### 3.2.4 标注服务

标注服务负责标注的管理，主要包括以下功能：

- **实体标注**：处理实体标注的CRUD操作
- **关系标注**：处理关系标注的CRUD操作
- **标注统计**：提供标注数据的统计功能

#### 3.2.5 可视化服务

可视化服务负责提供可视化所需的数据，主要包括以下功能：

- **数据总览**：提供文档的基本统计信息
- **实体分布**：提供实体类型的分布情况
- **人物关系**：提供人物之间的关系数据
- **时间轴**：提供时间序列数据
- **地点分布**：提供地名在地图上的分布数据

### 3.3 代理层设计

后端服务中包含一个代理层，用于将AI服务和分词服务的请求转发到相应的服务。代理层的设计实现了服务之间的解耦，便于系统的扩展和维护。

### 3.4 中间件设计

- **auth.js**：身份验证中间件，验证用户的JWT令牌
- **cors.js**：跨域资源共享中间件，允许前端应用访问后端API
- **errorHandler.js**：错误处理中间件，统一处理系统错误

## 4. AI服务详细设计

### 4.1 AI服务目录结构

```
AI/
├── ai.py               # AI服务主程序
├── config.py           # 配置文件
└── requirements.txt    # 依赖配置
```

### 4.2 AI服务功能

AI服务主要负责文本的智能分析和生成，主要包括以下功能：

- **文本分析**：对古文文本进行智能分析，包括段落划分、句子解析等
- **问答功能**：支持用户针对古文文本提出问题，系统自动回答
- **自动标注**：自动标注文本中的实体，如人物、地名、时间等

### 4.3 AI模型集成

AI服务集成了两种模型，用于文本分析和生成：

1. **DeepSeek API**：通用大语言模型，用于文本生成和问答
2. **荀子古汉语大模型**：基于魔搭平台的Xunzillm4cc/Xunzi-Qwen2-1.5B模型，专门用于古汉语文本分析和生成

模型的调用通过HTTP API进行，支持以下功能：

- 文本生成
- 文本分类
- 命名实体识别
- 问答系统
- 古汉语翻译
- 古汉语实体标注

## 5. 数据库设计

### 5.1 数据库表结构

#### 5.1.1 用户表（users）

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | 邮箱 |
| password | VARCHAR(255) | NOT NULL | 密码（加密存储） |
| settings | JSON | DEFAULT NULL | 用户设置 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| is_active | BOOLEAN | DEFAULT TRUE | 用户状态 |
| last_login | TIMESTAMP | DEFAULT NULL | 最后登录时间 |

#### 5.1.2 项目表（projects）

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 项目ID |
| user_id | INT | FOREIGN KEY REFERENCES users(id) | 用户ID |
| name | VARCHAR(100) | NOT NULL | 项目名称 |
| description | TEXT | DEFAULT NULL | 项目描述 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 5.1.3 文档表（documents）

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | VARCHAR(50) | PRIMARY KEY | 文档ID |
| user_id | INT | FOREIGN KEY REFERENCES users(id) | 用户ID |
| project_id | VARCHAR(50) | FOREIGN KEY REFERENCES projects(id) | 项目ID |
| name | VARCHAR(100) | NOT NULL | 文档名称 |
| description | TEXT | DEFAULT NULL | 文档描述 |
| content | LONGTEXT | DEFAULT NULL | 文档内容 |
| author | VARCHAR(100) | DEFAULT NULL | 作者 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 5.1.4 标注表（annotations）

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 标注ID |
| document_id | VARCHAR(50) | FOREIGN KEY REFERENCES documents(id) | 文档ID |
| type | VARCHAR(20) | NOT NULL | 标注类型（entity/relation） |
| start | INT | DEFAULT NULL | 实体开始位置 |
| end | INT | DEFAULT NULL | 实体结束位置 |
| label | VARCHAR(50) | DEFAULT NULL | 实体标签 |
| text | VARCHAR(255) | DEFAULT NULL | 实体文本 |
| source_id | INT | DEFAULT NULL | 关系源实体ID |
| target_id | INT | DEFAULT NULL | 关系目标实体ID |
| relation_type | VARCHAR(50) | DEFAULT NULL | 关系类型 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

#### 5.1.5 地名坐标缓存表（location_geocodes）

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 记录ID |
| name | VARCHAR(100) | NOT NULL | 地名 |
| lng | DOUBLE | NOT NULL | 经度 |
| lat | DOUBLE | NOT NULL | 纬度 |
| matched_name | VARCHAR(100) | DEFAULT NULL | 匹配的地名 |
| confidence | DOUBLE | DEFAULT NULL | 匹配置信度 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 5.2 数据库索引设计

为了提高数据库查询性能，设计了以下索引：

- **users**：username（唯一索引）、email（唯一索引）
- **projects**：user_id（普通索引）、created_at（普通索引）
- **documents**：user_id（普通索引）、project_id（普通索引）、created_at（普通索引）
- **annotations**：document_id（普通索引）、type（普通索引）、label（普通索引）
- **location_geocodes**：name（普通索引）

### 5.3 数据库迁移设计

数据库迁移使用SQL脚本进行，主要包括以下迁移文件：

- **init_database.sql**：初始化数据库表结构
- **add_settings_column.sql**：添加用户设置列
- **add_relation_annotations.sql**：添加关系标注支持
- **create_location_geocodes.sql**：创建地名坐标缓存表

## 6. API详细设计

### 6.1 API设计原则

- **RESTful设计**：遵循RESTful API设计规范
- **统一响应格式**：所有API返回统一的响应格式
- **错误处理**：统一的错误处理机制
- **认证机制**：使用JWT进行身份验证

### 6.2 API响应格式

所有API返回以下统一格式：

```json
{
  "success": true/false,
  "data": {...}, // 响应数据
  "error": "错误信息", // 错误信息（可选）
  "message": "提示信息" // 提示信息（可选）
}
```

### 6.3 核心API设计

#### 6.3.1 用户管理API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 登录 | POST | /api/login | 用户登录 | 否 |
| 注册 | POST | /api/register | 用户注册 | 否 |
| 更新用户 | PATCH | /api/users/:userId | 更新用户信息 | 是 |
| 获取用户列表 | GET | /api/users | 获取所有用户 | 是 |
| 获取用户详情 | GET | /api/users/:userId | 获取用户详情 | 是 |
| 更新设置 | PUT | /api/users/:userId/settings | 更新用户设置 | 是 |
| 修改密码 | POST | /api/users/:userId/change-password | 修改用户密码 | 是 |

#### 6.3.2 项目管理API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 获取项目列表 | GET | /api/projects | 获取用户的所有项目 | 是 |
| 获取项目详情 | GET | /api/projects/:projectId | 获取项目详情 | 是 |
| 创建项目 | POST | /api/projects | 创建新项目 | 是 |
| 更新项目 | PUT | /api/projects/:projectId | 更新项目信息 | 是 |
| 删除项目 | DELETE | /api/projects/:projectId | 删除项目 | 是 |

#### 6.3.3 文档管理API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 获取文档列表 | GET | /api/documents | 获取用户的所有文档 | 是 |
| 获取文档详情 | GET | /api/documents/:documentId | 获取文档详情 | 是 |
| 创建文档 | POST | /api/documents | 创建新文档 | 是 |
| 更新文档 | PUT | /api/documents/:documentId | 更新文档信息 | 是 |
| 删除文档 | DELETE | /api/documents/:documentId | 删除文档 | 是 |
| 搜索文档 | GET | /api/documents/search | 搜索文档 | 是 |
| 导出文档 | POST | /api/export-documents | 导出文档 | 是 |

#### 6.3.4 标注管理API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 获取标注列表 | GET | /api/documents/:documentId/annotations | 获取文档的所有标注 | 是 |
| 添加实体标注 | POST | /api/documents/:documentId/annotations/entity | 添加实体标注 | 是 |
| 批量添加实体标注 | POST | /api/documents/:documentId/annotations/entity/bulk | 批量添加实体标注 | 是 |
| 删除实体标注 | DELETE | /api/documents/:documentId/annotations/entity/:annotationId | 删除实体标注 | 是 |
| 搜索实体标注 | GET | /api/annotations/search | 搜索实体标注 | 是 |
| 统计实体标注数量 | GET | /api/documents/:documentId/annotations/count | 统计实体标注数量 | 是 |

#### 6.3.5 AI服务API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 文本分析 | POST | /ai/api/analyze | 文本分析 | 否 |
| 问答 | POST | /ai/api/qa | 文本问答 | 否 |
| 自动标注 | POST | /ai/api/auto-annotate | 自动标注实体 | 否 |

#### 6.3.6 可视化API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 获取可视化总览 | GET | /api/visualization/overview | 获取可视化总览数据 | 是 |
| 获取地点可视化数据 | GET | /api/visualization/locations | 获取地点可视化数据 | 是 |
| 获取人物关系数据 | GET | /api/visualization/relationships | 获取人物关系数据 | 是 |
| 获取时间轴数据 | GET | /api/visualization/timeline | 获取时间轴数据 | 是 |

#### 6.3.7 地名坐标缓存API

| 接口 | 方法 | 路径 | 功能 | 认证 |
|------|------|------|------|------|
| 查询地名坐标缓存 | GET | /api/visualization/locations/cache | 查询地名坐标缓存 | 是 |
| 更新地名坐标缓存 | POST | /api/visualization/locations/cache | 更新地名坐标缓存 | 是 |

## 7. 安全性设计

### 7.1 认证与授权

- 使用JWT进行身份验证
- 密码使用哈希算法加密存储
- 敏感数据在传输过程中使用HTTPS加密

### 7.2 输入验证

- 所有用户输入进行严格的验证
- 使用参数化查询防止SQL注入
- 对用户输入进行XSS过滤

### 7.3 访问控制

- 基于角色的访问控制
- 用户只能访问自己的资源
- 敏感操作需要二次验证

### 7.4 日志与监控

- 记录系统日志，便于故障排查
- 监控系统性能和资源使用情况
- 定期进行安全审计

## 8. 性能优化设计

### 8.1 前端性能优化

- 使用React.lazy和Suspense进行组件懒加载
- 优化图片资源
- 使用缓存机制减少API请求
- 优化渲染性能，减少不必要的重渲染

### 8.2 后端性能优化

- 使用数据库连接池
- 优化SQL查询，添加适当的索引
- 使用缓存机制，如Redis
- 异步处理耗时操作

### 8.3 AI服务性能优化

- 使用模型缓存减少API调用次数
- 优化模型调用参数
- 异步处理AI请求

## 9. 测试设计

### 9.1 测试策略

- **单元测试**：测试单个组件或函数
- **集成测试**：测试组件之间的交互
- **API测试**：测试API的功能和性能
- **端到端测试**：测试完整的用户流程

### 9.2 测试工具

- **前端测试**：Jest、React Testing Library
- **后端测试**：Mocha、Chai、Supertest
- **API测试**：Postman、Newman
- **性能测试**：JMeter、Locust

## 10. 部署与运维设计

### 10.1 部署方案

- 使用Docker容器化部署
- 使用Docker Compose管理多个服务
- 使用Nginx作为反向代理

### 10.2 监控与告警

- 使用Prometheus进行系统监控
- 使用Grafana进行可视化监控
- 配置告警机制，及时发现和处理问题

### 10.3 备份与恢复

- 定期备份数据库
- 实现数据恢复机制
- 测试备份和恢复流程

## 11. 总结

本项目详细设计文档对古文智能标注与解析系统的架构、模块、数据库和API进行了详细的设计。系统采用前后端分离的架构，具有高度的模块化和可扩展性。通过集成AI模型，实现了古文文本的智能分析和自动标注，为古籍研究提供了有力的工具支持。

系统的设计考虑了性能、安全性和可用性等方面，采用了多种优化技术和安全措施。同时，系统具有良好的可扩展性，可以根据需求进行扩展和升级。

本设计文档为系统的开发、测试和部署提供了详细的指导，确保系统能够按照预期的目标实现。